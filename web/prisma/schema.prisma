// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==============================
// Enums
// ==============================

enum Role {
  ADMIN
  MANAGER
  CASHIER
}

enum PurchaseOrderStatus {
  DRAFT
  SUBMITTED
  RECEIVED
  CANCELLED
}

enum SaleStatus {
  OPEN
  COMPLETED
  REFUNDED
  VOIDED
}

enum StockMovementType {
  PURCHASE_RECEIPT
  SALE
  RETURN
  ADJUSTMENT
}

// ==============================
// NextAuth core models
// https://authjs.dev/reference/adapter/prisma
// ==============================

model User {
  id            String   @id @default(cuid())
  name          String?
  email         String?  @unique
  emailVerified DateTime?
  image         String?

  // App-specific fields
  role         Role     @default(CASHIER)
  passwordHash String?

  // Relations
  accounts Account[]
  sessions Session[]
  sales    Sale[]      @relation("SaleCashier")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==============================
// Domain models
// ==============================

model Category {
  id        String    @id @default(cuid())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Product {
  id             String    @id @default(cuid())
  name           String
  sku            String    @unique
  barcode        String?   @unique
  description    String?
  imageUrl       String?
  categoryId     String?
  category       Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  cost           Decimal   @default(0)
  price          Decimal   @default(0)
  stockQuantity  Int       @default(0)
  reorderLevel   Int       @default(0)
  isActive       Boolean   @default(true)

  purchaseItems PurchaseOrderItem[]
  saleItems     SaleItem[]
  movements     StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Supplier {
  id         String   @id @default(cuid())
  name       String   @unique
  contact    String?
  phone      String?
  email      String?
  address    String?
  notes      String?
  orders     PurchaseOrder[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model PurchaseOrder {
  id          String               @id @default(cuid())
  supplierId  String
  supplier    Supplier             @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  status      PurchaseOrderStatus  @default(DRAFT)
  expectedAt  DateTime?
  receivedAt  DateTime?
  totalCost   Decimal              @default(0)
  items       PurchaseOrderItem[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  productId       String
  quantity        Int
  cost            Decimal       @default(0)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([purchaseOrderId, productId])
}

model Customer {
  id             String   @id @default(cuid())
  name           String
  phone          String?  @unique
  email          String?  @unique
  loyaltyPoints  Int      @default(0)
  sales          Sale[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Sale {
  id          String      @id @default(cuid())
  cashierId   String
  cashier     User        @relation("SaleCashier", fields: [cashierId], references: [id])
  customerId  String?
  customer    Customer?   @relation(fields: [customerId], references: [id])
  status      SaleStatus  @default(OPEN)
  subtotal    Decimal     @default(0)
  tax         Decimal     @default(0)
  total       Decimal     @default(0)
  paymentMethod String?
  invoiceNumber String?   @unique
  items       SaleItem[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model SaleItem {
  id        String  @id @default(cuid())
  saleId    String
  productId String
  quantity  Int
  price     Decimal @default(0)
  discount  Decimal @default(0)

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([saleId, productId])
}

model StockMovement {
  id         String            @id @default(cuid())
  productId  String
  type       StockMovementType
  quantity   Int
  note       String?
  saleId     String?
  poId       String?
  createdAt  DateTime          @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Settings {
  id             Int      @id @default(1)
  storeName      String   @default("My Grocery Store")
  currency       String   @default("USD")
  taxRate        Decimal  @default(0.00)
  lowStockLevel  Int      @default(5)
  updatedAt      DateTime @updatedAt
}
